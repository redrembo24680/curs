<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–æ–≤–∏–Ω–∏ ¬∑ –°–∏—Å—Ç–µ–º–∞ –≥–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
<nav class="navbar">
    <div class="logo">‚öΩ –ì–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è</div>
    <ul class="nav-links">
        <li><a href="/">–ì–æ–ª–æ–≤–Ω–∞</a></li>
        <li><a href="/players">–ì—Ä–∞–≤—Ü—ñ</a></li>
        <li><a href="/matches">–ú–∞—Ç—á—ñ</a></li>
        <li><a href="/stats">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a></li>
        <li><a href="/posts" class="active">–ù–æ–≤–∏–Ω–∏</a></li>
        <li><a href="/profile">–ü—Ä–æ—Ñ—ñ–ª—å</a></li>
        <li><a href="/health">–°—Ç–∞–Ω API</a></li>
    </ul>
    <div class="nav-meta">
        <div class="stats-bar" id="stats-bar">
            <span>üë• 0 –≥—Ä–∞–≤—Ü—ñ–≤</span>
            <span>üèüÔ∏è 0 –º–∞—Ç—á—ñ–≤</span>
            <span>üó≥Ô∏è 0 –≥–æ–ª–æ—Å—ñ–≤</span>
        </div>
        <div class="auth-bar" id="auth-bar">
            <a class="btn ghost" href="/login">–£–≤—ñ–π—Ç–∏</a>
            <a class="btn primary small" href="/register">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</a>
        </div>
    </div>
</nav>

<main>
    <div id="flash-container"></div>

    <section class="section">
        <div class="card" id="create-post-card" style="display: none; margin-bottom: 2rem;">
            <h2>–°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–Ω—É</h2>
            <form id="create-post-form" class="form">
                <label for="post-title">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
                <input type="text" id="post-title" name="title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–æ–≤–∏–Ω–∏" required>
                
                <label for="post-content">–¢–µ–∫—Å—Ç</label>
                <textarea id="post-content" name="content" rows="5" placeholder="–¢–µ–∫—Å—Ç –Ω–æ–≤–∏–Ω–∏" required></textarea>
                
                <button type="submit" class="btn primary">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>
            </form>
        </div>
    </section>

    <section class="section">
        <h2>–ù–æ–≤–∏–Ω–∏ —Ç–∞ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</h2>
        <div id="posts-list">
            <p class="muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
        </div>
    </section>
</main>

<footer>
    –°–∏—Å—Ç–µ–º–∞ –≥–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è –∑–∞ –≥—Ä–∞–≤—Ü—ñ–≤ &middot; Backend: C++ ¬∑ Frontend: Static HTML
</footer>

<script src="/static/app.js"></script>
<script>
let currentUser = null;

async function checkUserStatus() {
    try {
        const response = await fetch('/api/user-info', {
            credentials: 'same-origin'
        });
        const userInfo = await response.json();
        currentUser = userInfo.logged_in ? userInfo : null;
        
        // Show create post form only for admins
        const createPostCard = document.getElementById('create-post-card');
        if (createPostCard && currentUser && currentUser.role === 'admin') {
            createPostCard.style.display = 'block';
        }
        
        // Update auth bar
        const authBar = document.getElementById('auth-bar');
        if (authBar) {
            if (userInfo.logged_in) {
                authBar.innerHTML = `
                    <span class="user-pill" style="margin-right: 0.5rem; padding: 0.5rem 1rem; background: #f3f4f6; border-radius: 20px; font-size: 0.9rem;">
                        ${userInfo.username || '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}
                        ${userInfo.role === 'admin' ? '<small style="margin-left: 0.5rem; padding: 0.2rem 0.5rem; background: #10b981; color: white; border-radius: 10px; font-size: 0.75rem;">Admin</small>' : ''}
                    </span>
                    <a class="btn ghost" href="/logout">–í–∏–π—Ç–∏</a>
                `;
            } else {
                authBar.innerHTML = `
                    <a class="btn ghost" href="/login">–£–≤—ñ–π—Ç–∏</a>
                    <a class="btn primary small" href="/register">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</a>
                `;
            }
        }
    } catch (error) {
        console.error('Error checking user status:', error);
    }
}

async function loadPosts() {
    try {
        const response = await fetch('/api/posts');
        const data = await response.json();
        const posts = data.posts || [];
        const postsDiv = document.getElementById('posts-list');
        
        if (posts.length === 0) {
            postsDiv.innerHTML = '<p class="muted">–ù–æ–≤–∏–Ω —â–µ –Ω–µ–º–∞—î.</p>';
            return;
        }
        
        postsDiv.innerHTML = posts.map(post => `
            <div class="card" style="margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                    <div>
                        <h3 style="margin: 0 0 0.5rem 0;">${post.title}</h3>
                        <p style="margin: 0; color: #6b7280; font-size: 0.875rem;">
                            ${post.username || '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'} ¬∑ ${new Date(post.created_at).toLocaleString('uk-UA')}
                        </p>
                    </div>
                    ${currentUser && currentUser.role === 'admin' && post.is_own ? `
                        <button class="btn ghost small" onclick="deletePost(${post.id})" style="color: #ef4444;">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                    ` : ''}
                </div>
                <p style="white-space: pre-wrap; line-height: 1.6;">${post.content}</p>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading posts:', error);
        document.getElementById('posts-list').innerHTML = '<p class="muted">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–æ–≤–∏–Ω.</p>';
    }
}

async function createPost(event) {
    event.preventDefault();
    
    if (!currentUser || currentUser.role !== 'admin') {
        showFlash('–¢—ñ–ª—å–∫–∏ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∏ –º–æ–∂—É—Ç—å —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –Ω–æ–≤–∏–Ω–∏', 'danger');
        return;
    }
    
    const formData = new FormData(event.target);
    const postData = {
        title: formData.get('title'),
        content: formData.get('content')
    };
    
    try {
        const response = await fetch('/api/posts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin',
            body: JSON.stringify(postData)
        });
        
        const result = await response.json();
        
        if (response.ok && result.status === 'success') {
            showFlash('–ù–æ–≤–∏–Ω—É —É—Å–ø—ñ—à–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ!', 'success');
            event.target.reset();
            loadPosts();
        } else {
            showFlash(result.error || '–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–∏–Ω–∏', 'danger');
        }
    } catch (error) {
        showFlash('–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —Å–µ—Ä–≤–µ—Ä–∞', 'danger');
        console.error('Create post error:', error);
    }
}

async function deletePost(postId) {
    if (!confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –Ω–æ–≤–∏–Ω—É?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/posts/${postId}`, {
            method: 'DELETE',
            credentials: 'same-origin'
        });
        
        const result = await response.json();
        
        if (response.ok && result.status === 'success') {
            showFlash('–ù–æ–≤–∏–Ω—É –≤–∏–¥–∞–ª–µ–Ω–æ', 'success');
            loadPosts();
        } else {
            showFlash(result.error || '–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è', 'danger');
        }
    } catch (error) {
        showFlash('–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —Å–µ—Ä–≤–µ—Ä–∞', 'danger');
        console.error('Delete post error:', error);
    }
}

document.addEventListener('DOMContentLoaded', async () => {
    loadGlobalStats();
    await checkUserStatus();
    loadPosts();
    
    const createPostForm = document.getElementById('create-post-form');
    if (createPostForm) {
        createPostForm.addEventListener('submit', createPost);
    }
});
</script>
</body>
</html>


