<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì—Ä–∞–≤—Ü—ñ ¬∑ –°–∏—Å—Ç–µ–º–∞ –≥–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/modal.css">
    <link rel="stylesheet" href="/static/stats.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
</head>

<body>
    <nav class="navbar">
        <div class="logo">‚öΩ –ì–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è</div>
        <ul class="nav-links">
            <li><a href="/">–ì–æ–ª–æ–≤–Ω–∞</a></li>
            <li><a href="/players" class="active">–ì—Ä–∞–≤—Ü—ñ</a></li>
            <li><a href="/matches">–ú–∞—Ç—á—ñ</a></li>
            <li><a href="/stats">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a></li>
            <li><a href="/posts">–ù–æ–≤–∏–Ω–∏</a></li>
            <li><a href="/profile">–ü—Ä–æ—Ñ—ñ–ª—å</a></li>
            <li><a href="/health">–°—Ç–∞–Ω API</a></li>
        </ul>
        <div class="nav-meta">
            <div class="stats-bar" id="stats-bar">
                <span>üë• 0 –≥—Ä–∞–≤—Ü—ñ–≤</span>
                <span>‚öΩ 0 –º–∞—Ç—á—ñ–≤</span>
                <span>üó≥Ô∏è 0 –≥–æ–ª–æ—Å—ñ–≤</span>
            </div>
            <div class="auth-bar" id="auth-bar">
                <a href="/login" class="btn ghost small">–£–≤—ñ–π—Ç–∏</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div id="flash-container"></div>

        <section class="section">
            <h1>–ì—Ä–∞–≤—Ü—ñ</h1>
            <p class="muted">–£ —Å–∏—Å—Ç–µ–º—ñ: <strong id="players-count">...</strong> –≥—Ä–∞–≤—Ü—ñ–≤</p>
        </section>

        <!-- Admin Forms -->
        <section class="section grid-two" id="admin-section" style="display: none;">
            <div class="card">
                <h2>–î–æ–¥–∞—Ç–∏ –∫–æ–º–∞–Ω–¥—É</h2>
                <form id="add-team-form" onsubmit="handleAddTeam(event)">
                    <label for="team_name">–ù–∞–∑–≤–∞ –∫–æ–º–∞–Ω–¥–∏</label>
                    <input type="text" name="name" id="team_name" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –î–∏–Ω–∞–º–æ –ö–∏—ó–≤" required>
                    <button type="submit" class="btn primary">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∫–æ–º–∞–Ω–¥—É</button>
                </form>
            </div>

            <div class="card">
                <h2>–î–æ–¥–∞—Ç–∏ –≥—Ä–∞–≤—Ü—è</h2>
                <form id="add-player-form" onsubmit="handleAddPlayer(event)">
                    <label for="player_name">–Ü–º'—è –≥—Ä–∞–≤—Ü—è</label>
                    <input type="text" name="name" id="player_name" placeholder="–Ü–º'—è –≥—Ä–∞–≤—Ü—è" required>

                    <label for="player_team_id">–ö–æ–º–∞–Ω–¥–∞</label>
                    <select name="team_id" id="player_team_id" required>
                        <option value="" disabled selected>–û–±–µ—Ä—ñ—Ç—å –∫–æ–º–∞–Ω–¥—É</option>
                    </select>

                    <label for="player_position">–ü–æ–∑–∏—Ü—ñ—è</label>
                    <select name="position" id="player_position" required>
                        <option value="GK">–í–æ—Ä–æ—Ç–∞—Ä (GK)</option>
                        <option value="LB">–õ—ñ–≤–∏–π –∑–∞—Ö–∏—Å–Ω–∏–∫ (LB)</option>
                        <option value="CB">–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∏–π –∑–∞—Ö–∏—Å–Ω–∏–∫ (CB)</option>
                        <option value="RB">–ü—Ä–∞–≤–∏–π –∑–∞—Ö–∏—Å–Ω–∏–∫ (RB)</option>
                        <option value="CDM">–û–ø–æ—Ä–Ω–∏–π –ø—ñ–≤–∑–∞—Ö–∏—Å–Ω–∏–∫ (CDM)</option>
                        <option value="CM">–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∏–π –ø—ñ–≤–∑–∞—Ö–∏—Å–Ω–∏–∫ (CM)</option>
                        <option value="CAM">–ê—Ç–∞–∫—É—é—á–∏–π –ø—ñ–≤–∑–∞—Ö–∏—Å–Ω–∏–∫ (CAM)</option>
                        <option value="LM">–õ—ñ–≤–∏–π –ø—ñ–≤–∑–∞—Ö–∏—Å–Ω–∏–∫ (LM)</option>
                        <option value="RM">–ü—Ä–∞–≤–∏–π –ø—ñ–≤–∑–∞—Ö–∏—Å–Ω–∏–∫ (RM)</option>
                        <option value="LW">–õ—ñ–≤–∏–π –≤—ñ–Ω–≥–µ—Ä (LW)</option>
                        <option value="RW">–ü—Ä–∞–≤–∏–π –≤—ñ–Ω–≥–µ—Ä (RW)</option>
                        <option value="ST">–ù–∞–ø–∞–¥–Ω–∏–∫ (ST)</option>
                    </select>

                    <button type="submit" class="btn primary">–î–æ–¥–∞—Ç–∏ –≥—Ä–∞–≤—Ü—è</button>
                </form>
            </div>
        </section>

        <section class="section">
            <h2>–°–ø–∏—Å–æ–∫ –≥—Ä–∞–≤—Ü—ñ–≤</h2>
            <div id="players-table">
                <p class="muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
            </div>
        </section>

        <section class="section">
            <h2>–î–æ—Å—Ç—É–ø–Ω—ñ –∫–æ–º–∞–Ω–¥–∏</h2>
            <div class="teams-grid" id="teams-container">
                <p class="muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
            </div>
        </section>
    </div>

    <footer class="footer">
        <p>&copy; 2024 –°–∏—Å—Ç–µ–º–∞ –≥–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è –∑–∞ –≥—Ä–∞–≤—Ü—ñ–≤. –í—Å—ñ –ø—Ä–∞–≤–∞ –∑–∞—Ö–∏—â–µ–Ω–æ.</p>
    </footer>

    <script src="/static/app.js"></script>
    <script>
        let teamsData = [];
        let currentUser = null;

        async function checkUserRole() {
            try {
                const response = await fetch('/api/user-info', {
                    credentials: 'same-origin'
                });
                const userInfo = await response.json();
                currentUser = userInfo.logged_in ? userInfo : null;

                // Show admin forms only for admins
                if (currentUser && currentUser.role === 'admin') {
                    document.getElementById('admin-section').style.display = 'grid';
                }
            } catch (error) {
                console.error('Error checking user role:', error);
            }
        }

        async function loadPlayers() {
            try {
                const teamsResponse = await api.get('/teams', { teams: [] });
                const playersResponse = await api.get('/players', { players: [] });

                teamsData = teamsResponse.teams || [];
                const players = playersResponse.players || [];

                document.getElementById('players-count').textContent = players.length;

                // Populate team select for adding players
                const teamSelect = document.getElementById('player_team_id');
                if (teamSelect) {
                    teamSelect.innerHTML = '<option value="" disabled selected>–û–±–µ—Ä—ñ—Ç—å –∫–æ–º–∞–Ω–¥—É</option>' +
                        teamsData.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
                }

                const teamsContainer = document.getElementById('teams-container');
                if (teamsData.length > 0) {
                    teamsContainer.innerHTML = teamsData.map(team =>
                        `<div class="team-card">
                            <h3>${team.name}</h3>
                            <p class="muted">ID: ${team.id}</p>
                        </div>`
                    ).join('');
                } else {
                    teamsContainer.innerHTML = '<p class="muted">–ö–æ–º–∞–Ω–¥ —â–µ –Ω–µ –¥–æ–¥–∞–Ω–æ.</p>';
                }

                const playersTable = document.getElementById('players-table');
                if (players.length > 0) {
                    playersTable.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>–Ü–º'—è</th>
                                    <th>–ö–æ–º–∞–Ω–¥–∞</th>
                                    <th>–ü–æ–∑–∏—Ü—ñ—è</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${players.map(player => {
                        const team = teamsData.find(t => t.id === player.team_id);
                        return `
                                        <tr>
                                            <td>${player.id}</td>
                                            <td><strong>${player.name}</strong></td>
                                            <td>${team ? team.name : '–ù–µ–≤—ñ–¥–æ–º–æ'}</td>
                                            <td><span class="badge">${player.position}</span></td>
                                        </tr>
                                    `;
                    }).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    playersTable.innerHTML = '<p class="muted">–ì—Ä–∞–≤—Ü—ñ–≤ —â–µ –Ω–µ –¥–æ–¥–∞–Ω–æ.</p>';
                }
            } catch (error) {
                console.error('Error loading players:', error);
                document.getElementById('players-table').innerHTML =
                    '<p class="error">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ API.</p>';
                document.getElementById('teams-container').innerHTML =
                    '<p class="error">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–æ–º–∞–Ω–¥.</p>';
            }
        }

        async function handleAddTeam(event) {
            event.preventDefault();

            if (!currentUser || currentUser.role !== 'admin') {
                showFlash('–¢—ñ–ª—å–∫–∏ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∏ –º–æ–∂—É—Ç—å —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –∫–æ–º–∞–Ω–¥–∏', 'danger');
                return;
            }

            const formData = new FormData(event.target);
            const teamData = {
                name: formData.get('name')
            };

            const result = await api.post('/teams/add', teamData);
            if (result.ok) {
                showFlash('–ö–æ–º–∞–Ω–¥—É —É—Å–ø—ñ—à–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ!', 'success');
                event.target.reset();
                loadPlayers(); // Reload to show new team
            } else {
                showFlash(result.result?.message || '–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ–º–∞–Ω–¥–∏', 'danger');
            }
        }

        async function handleAddPlayer(event) {
            event.preventDefault();

            if (!currentUser || currentUser.role !== 'admin') {
                showFlash('–¢—ñ–ª—å–∫–∏ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∏ –º–æ–∂—É—Ç—å –¥–æ–¥–∞–≤–∞—Ç–∏ –≥—Ä–∞–≤—Ü—ñ–≤', 'danger');
                return;
            }

            const formData = new FormData(event.target);
            const playerData = {
                name: formData.get('name'),
                position: formData.get('position'),
                team_id: parseInt(formData.get('team_id'))
            };

            const result = await api.post('/players/add', playerData);
            if (result.ok) {
                showFlash('–ì—Ä–∞–≤—Ü—è —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–æ!', 'success');
                event.target.reset();
                loadPlayers(); // Reload to show new player
            } else {
                showFlash(result.result?.message || '–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –≥—Ä–∞–≤—Ü—è', 'danger');
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await checkUserRole();
            loadPlayers();
        });
    </script>
</body>

</html>