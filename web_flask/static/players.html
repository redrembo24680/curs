<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì—Ä–∞–≤—Ü—ñ ¬∑ –°–∏—Å—Ç–µ–º–∞ –≥–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
<nav class="navbar">
    <div class="logo">‚öΩ –ì–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è</div>
    <ul class="nav-links">
        <li><a href="/">–ì–æ–ª–æ–≤–Ω–∞</a></li>
        <li><a href="/players" class="active">–ì—Ä–∞–≤—Ü—ñ</a></li>
        <li><a href="/matches">–ú–∞—Ç—á—ñ</a></li>
        <li><a href="/stats">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a></li>
        <li><a href="/posts">–ù–æ–≤–∏–Ω–∏</a></li>
        <li><a href="/profile">–ü—Ä–æ—Ñ—ñ–ª—å</a></li>
        <li><a href="/health">–°—Ç–∞–Ω API</a></li>
    </ul>
    <div class="nav-meta">
        <div class="stats-bar" id="stats-bar">
            <span>üë• 0 –≥—Ä–∞–≤—Ü—ñ–≤</span>
            <span>üèüÔ∏è 0 –º–∞—Ç—á—ñ–≤</span>
            <span>üó≥Ô∏è 0 –≥–æ–ª–æ—Å—ñ–≤</span>
        </div>
        <div class="auth-bar" id="auth-bar">
            <a class="btn ghost" href="/login">–£–≤—ñ–π—Ç–∏</a>
            <a class="btn primary small" href="/register">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</a>
        </div>
    </div>
</nav>

<main>
    <div id="flash-container"></div>

    <section class="section grid-two">
        <div class="card">
            <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≥—Ä–∞–≤—Ü—ñ–≤</h2>
            <p>–£ —Å–∏—Å—Ç–µ–º—ñ: <strong id="players-count">0</strong> –≥—Ä–∞–≤—Ü—ñ–≤.</p>
            <p class="muted">–°–ø–∏—Å–æ–∫ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î—Ç—å—Å—è –∑ –±–∞–∑–æ—é —Å–ø—Ä–∞–≤–∂–Ω—ñ—Ö –∫–æ–º–∞–Ω–¥.</p>
        </div>
        <div class="card" id="admin-forms-card">
            <div id="admin-forms-content">
                <p class="muted">–£–≤—ñ–π–¥—ñ—Ç—å —è–∫ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä, —â–æ–± —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –∫–æ–º–∞–Ω–¥–∏ —Ç–∞ –≥—Ä–∞–≤—Ü—ñ–≤.</p>
            </div>
        </div>
    </section>

    <section class="section">
        <h2>–°–ø–∏—Å–æ–∫ –≥—Ä–∞–≤—Ü—ñ–≤</h2>
        <div id="players-table-container">
            <p class="muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
        </div>
    </section>

    <section class="section">
        <h2>–î–æ—Å—Ç—É–ø–Ω—ñ –∫–æ–º–∞–Ω–¥–∏</h2>
        <div id="teams-grid" class="teams-grid">
            <p class="muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
        </div>
    </section>
</main>

<footer>
    –°–∏—Å—Ç–µ–º–∞ –≥–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è –∑–∞ –≥—Ä–∞–≤—Ü—ñ–≤ &middot; Backend: C++ ¬∑ Frontend: Static HTML
</footer>

<script src="/static/app.js"></script>
<script>
async function loadPlayers() {
    const data = await api.get('/players-page', { players: [], teams: [] });
    const players = data.players || [];
    const teams = data.teams || [];
    
    document.getElementById('players-count').textContent = players.length;
    
    // Populate team select for adding players
    const teamSelect = document.getElementById('player_team_id');
    if (teamSelect) {
        teamSelect.innerHTML = '<option value="" disabled selected>–û–±–µ—Ä—ñ—Ç—å –∫–æ–º–∞–Ω–¥—É</option>' +
            teams.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
    }
    
    // Render players table
    if (players.length === 0) {
        document.getElementById('players-table-container').innerHTML = '<p class="muted">–ì—Ä–∞–≤—Ü—ñ–≤ —â–µ –Ω–µ –¥–æ–¥–∞–Ω–æ.</p>';
    } else {
        const teamMap = {};
        teams.forEach(t => teamMap[t.id] = t.name);
        
        const tableHTML = `
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–Ü–º'—è</th>
                        <th>–ö–æ–º–∞–Ω–¥–∞</th>
                        <th>–ü–æ–∑–∏—Ü—ñ—è</th>
                        <th>–ì–æ–ª–æ—Å—ñ–≤</th>
                    </tr>
                </thead>
                <tbody>
                    ${players.map(p => `
                        <tr>
                            <td>${p.id}</td>
                            <td>${p.name}</td>
                            <td>${teamMap[p.team_id] || ''}</td>
                            <td>${p.position}</td>
                            <td>${p.votes || 0}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        document.getElementById('players-table-container').innerHTML = tableHTML;
    }
    
    // Render teams
    if (teams.length === 0) {
        document.getElementById('teams-grid').innerHTML = '<p class="muted">–ö–æ–º–∞–Ω–¥ —â–µ –Ω–µ –¥–æ–¥–∞–Ω–æ.</p>';
    } else {
        document.getElementById('teams-grid').innerHTML = teams.map(t => `
            <div class="team-card">
                <h3>${t.name}</h3>
                <p class="muted">ID: ${t.id}</p>
            </div>
        `).join('');
    }
}

// Check user login status
async function checkUserLoginStatus() {
    try {
        const response = await fetch('/api/user-info', {
            method: 'GET',
            credentials: 'same-origin',
            headers: {
                'Accept': 'application/json',
                'Cache-Control': 'no-cache'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const userInfo = await response.json();
        window.userLoggedIn = userInfo.logged_in || false;
        window.currentUser = userInfo.logged_in ? userInfo : null;
        
        // Show admin forms only if user is admin
        const adminCard = document.getElementById('admin-forms-card');
        if (adminCard) {
            if (window.currentUser && window.currentUser.role === 'admin') {
                adminCard.innerHTML = `
                    <h2>–î–æ–¥–∞—Ç–∏ –∫–æ–º–∞–Ω–¥—É</h2>
                    <form id="add-team-form" class="form" style="margin-bottom: 1.5rem;">
                        <label for="team_name">–ù–∞–∑–≤–∞ –∫–æ–º–∞–Ω–¥–∏</label>
                        <input type="text" name="name" id="team_name" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –î–∏–Ω–∞–º–æ –ö–∏—ó–≤" required>
                        <button type="submit" class="btn primary small">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∫–æ–º–∞–Ω–¥—É</button>
                    </form>

                    <h2>–î–æ–¥–∞—Ç–∏ –≥—Ä–∞–≤—Ü—è</h2>
                    <form id="add-player-form" class="form">
                        <label for="player_name">–Ü–º'—è –≥—Ä–∞–≤—Ü—è</label>
                        <input type="text" name="name" id="player_name" placeholder="–Ü–º'—è –≥—Ä–∞–≤—Ü—è" required>

                        <label for="player_team_id">–ö–æ–º–∞–Ω–¥–∞</label>
                        <select name="team_id" id="player_team_id" required>
                            <option value="" disabled selected>–û–±–µ—Ä—ñ—Ç—å –∫–æ–º–∞–Ω–¥—É</option>
                        </select>

                        <label for="player_position">–ü–æ–∑–∏—Ü—ñ—è</label>
                        <select name="position" id="player_position" required>
                            <option value="GK">–í–æ—Ä–æ—Ç–∞—Ä (GK)</option>
                            <option value="LB">–õ—ñ–≤–∏–π –∑–∞—Ö–∏—Å–Ω–∏–∫ (LB)</option>
                            <option value="CB">–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∏–π –∑–∞—Ö–∏—Å–Ω–∏–∫ (CB)</option>
                            <option value="RB">–ü—Ä–∞–≤–∏–π –∑–∞—Ö–∏—Å–Ω–∏–∫ (RB)</option>
                            <option value="CDM">–û–ø–æ—Ä–Ω–∏–π –ø—ñ–≤–∑–∞—Ö–∏—Å–Ω–∏–∫ (CDM)</option>
                            <option value="CM">–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∏–π –ø—ñ–≤–∑–∞—Ö–∏—Å–Ω–∏–∫ (CM)</option>
                            <option value="CAM">–ê—Ç–∞–∫—É—é—á–∏–π –ø—ñ–≤–∑–∞—Ö–∏—Å–Ω–∏–∫ (CAM)</option>
                            <option value="LM">–õ—ñ–≤–∏–π –ø—ñ–≤–∑–∞—Ö–∏—Å–Ω–∏–∫ (LM)</option>
                            <option value="RM">–ü—Ä–∞–≤–∏–π –ø—ñ–≤–∑–∞—Ö–∏—Å–Ω–∏–∫ (RM)</option>
                            <option value="LW">–õ—ñ–≤–∏–π –≤—ñ–Ω–≥–µ—Ä (LW)</option>
                            <option value="RW">–ü—Ä–∞–≤–∏–π –≤—ñ–Ω–≥–µ—Ä (RW)</option>
                            <option value="ST">–ù–∞–ø–∞–¥–Ω–∏–∫ (ST)</option>
                        </select>

                        <button type="submit" class="btn primary">–î–æ–¥–∞—Ç–∏ –≥—Ä–∞–≤—Ü—è</button>
                    </form>
                `;
                
                // Re-attach form handlers
                const addTeamForm = document.getElementById('add-team-form');
                if (addTeamForm) {
                    addTeamForm.addEventListener('submit', handleAddTeam);
                }
                const addPlayerForm = document.getElementById('add-player-form');
                if (addPlayerForm) {
                    addPlayerForm.addEventListener('submit', handleAddPlayer);
                }
            } else {
                adminCard.innerHTML = '<p class="muted">–£–≤—ñ–π–¥—ñ—Ç—å —è–∫ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä, —â–æ–± —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –∫–æ–º–∞–Ω–¥–∏ —Ç–∞ –≥—Ä–∞–≤—Ü—ñ–≤.</p>';
            }
        }
    } catch (error) {
        console.error('Error checking login status:', error);
        window.userLoggedIn = false;
        window.currentUser = null;
    }
}

// Update auth bar
async function updateAuthBar() {
    const authBar = document.getElementById('auth-bar');
    if (!authBar) return;
    
    try {
        const response = await fetch('/api/user-info', {
            method: 'GET',
            credentials: 'same-origin',
            headers: {
                'Accept': 'application/json',
                'Cache-Control': 'no-cache'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const userInfo = await response.json();
        
        if (userInfo.logged_in) {
            authBar.innerHTML = `
                <span class="user-pill" style="margin-right: 0.5rem; padding: 0.5rem 1rem; background: #f3f4f6; border-radius: 20px; font-size: 0.9rem;">
                    ${userInfo.username || '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á'}
                    ${userInfo.role === 'admin' ? '<small style="margin-left: 0.5rem; padding: 0.2rem 0.5rem; background: #10b981; color: white; border-radius: 10px; font-size: 0.75rem;">Admin</small>' : ''}
                </span>
                <a class="btn ghost" href="/logout">–í–∏–π—Ç–∏</a>
            `;
        } else {
            authBar.innerHTML = `
                <a class="btn ghost" href="/login">–£–≤—ñ–π—Ç–∏</a>
                <a class="btn primary small" href="/register">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</a>
            `;
        }
    } catch (error) {
        console.error('Error loading user info:', error);
        authBar.innerHTML = `
            <a class="btn ghost" href="/login">–£–≤—ñ–π—Ç–∏</a>
            <a class="btn primary small" href="/register">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</a>
        `;
    }
}

// Handle add team form
async function handleAddTeam(event) {
    event.preventDefault();
    
    // Check if user is admin
    if (!window.currentUser || window.currentUser.role !== 'admin') {
        showFlash('–¢—ñ–ª—å–∫–∏ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∏ –º–æ–∂—É—Ç—å —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –∫–æ–º–∞–Ω–¥–∏', 'danger');
        return;
    }
    
    const formData = new FormData(event.target);
    const teamData = {
        name: formData.get('name')
    };

    const result = await api.post('/teams/add', teamData);
    if (result.ok) {
        showFlash('–ö–æ–º–∞–Ω–¥—É —É—Å–ø—ñ—à–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ!', 'success');
        event.target.reset();
        loadPlayers(); // Reload to show new team
    } else {
        showFlash(result.result.message || '–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ–º–∞–Ω–¥–∏', 'danger');
    }
}

// Handle add player form
async function handleAddPlayer(event) {
    event.preventDefault();
    
    // Check if user is admin
    if (!window.currentUser || window.currentUser.role !== 'admin') {
        showFlash('–¢—ñ–ª—å–∫–∏ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∏ –º–æ–∂—É—Ç—å –¥–æ–¥–∞–≤–∞—Ç–∏ –≥—Ä–∞–≤—Ü—ñ–≤', 'danger');
        return;
    }
    
    const formData = new FormData(event.target);
    const playerData = {
        name: formData.get('name'),
        position: formData.get('position'),
        team_id: formData.get('team_id')
    };

    const result = await api.post('/players/add', playerData);
    if (result.ok) {
        showFlash('–ì—Ä–∞–≤—Ü—è —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–æ!', 'success');
        event.target.reset();
        loadPlayers(); // Reload to show new player
    } else {
        showFlash(result.result.message || '–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –≥—Ä–∞–≤—Ü—è', 'danger');
    }
}

document.addEventListener('DOMContentLoaded', async () => {
    // Check user login status first
    await checkUserLoginStatus();
    updateAuthBar();
    
    loadPlayers();
});
</script>
</body>
</html>

